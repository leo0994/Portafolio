---
import Header from "../components/Header.astro";
import "../styles/global.css";
import "../styles/header.css";
import "@fontsource/work-sans/400.css";
import Footer from "../components/Footer.astro";

const { description, title } = Astro.props;
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      rel="icon"
      type="image/png"
      href="/Portafolio/icons/logoplasmaceleste.png"
    />

    <meta name="generator" content={Astro.generator} />
    <title>Leo Portafolio</title>

    <!-- GSAP CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"
    ></script>

    <!-- i18next CDN -->
    <script src="https://unpkg.com/i18next@23.4.6/dist/umd/i18next.js"></script>

    <!-- Typed.js CDN -->
    <script
      src="https://unpkg.com/typed.js@2.1.0/dist/typed.umd.js"
      onload="console.log('‚úÖ Typed.js cargado desde CDN'); window.typedLoaded = true;"
    ></script>
  </head>
  <body>
    <Header />
    <slot />
    <Footer />
    <div class="h-10"></div>
  </body>

  <script is:inline>
    document.addEventListener("DOMContentLoaded", () => {
      console.log("üöÄ DOM cargado, iniciando i18next...");

      const savedLang = localStorage.getItem("lang");
      const userLang =
        savedLang || (navigator.language.startsWith("en") ? "en" : "es");

      // Cargar traducciones primero
      Promise.all([
        fetch("/Portafolio/locales/es/translation.json").then((r) => r.json()),
        fetch("/Portafolio/locales/en/translation.json").then((r) => r.json()),
      ])
        .then(([esData, enData]) => {
          console.log("‚úÖ Traducciones descargadas");

          // Inicializar i18next con los recursos ya cargados
          return i18next.init({
            lng: userLang,
            debug: true,
            resources: {
              es: { translation: esData },
              en: { translation: enData },
            },
          });
        })
        .then(() => {
          console.log("‚úÖ i18next inicializado con idioma:", i18next.language);
          inicializarSistemaIdiomas();
        })
        .catch((error) => {
          console.error("‚ùå Error:", error);
        });

      function actualizarTextos() {
        console.log("üîÑ Actualizando textos...");
        document.querySelectorAll("[data-i18n]").forEach((el) => {
          const clave = el.getAttribute("data-i18n");
          const traduccion = i18next.t(clave);
          if (el.tagName === "INPUT" || el.tagName === "TEXTAREA") {
            el.setAttribute("placeholder", traduccion);
          } else {
            el.innerText = traduccion;
          }
        });
      }

      function actualizarBotonesIdioma() {
        const proximoIdioma = i18next.language === "es" ? "EN" : "ES";
        const btnDesktop = document.getElementById("language-toggle");
        const btnMobile = document.getElementById("language-toggle-mobile");

        if (btnDesktop) btnDesktop.innerText = proximoIdioma;
        if (btnMobile) btnMobile.innerText = proximoIdioma;
        console.log("‚úÖ Botones actualizados:", proximoIdioma);
      }

      function toggleIdioma() {
        const nuevoIdioma = i18next.language === "es" ? "en" : "es";
        console.log(`üîÑ Cambiando idioma a ${nuevoIdioma}`);
        localStorage.setItem("lang", nuevoIdioma);
        i18next.changeLanguage(nuevoIdioma).then(() => {
          actualizarTextos();
          actualizarBotonesIdioma();
          console.log("‚úÖ Idioma cambiado");
          // Disparar evento para actualizar Typed.js
          window.dispatchEvent(new Event("languageChanged"));
        });
      }

      function inicializarSistemaIdiomas() {
        console.log("üöÄ Inicializando sistema de idiomas");
        actualizarTextos();
        actualizarBotonesIdioma();

        const btnDesktop = document.getElementById("language-toggle");
        const btnMobile = document.getElementById("language-toggle-mobile");

        if (btnDesktop) {
          btnDesktop.addEventListener("click", toggleIdioma);
          console.log("‚úÖ Listener agregado a bot√≥n desktop");
        }
        if (btnMobile) {
          btnMobile.addEventListener("click", toggleIdioma);
          console.log("‚úÖ Listener agregado a bot√≥n m√≥vil");
        }
      }

      window.debugLanguage = {
        toggleIdioma,
        actualizarTextos,
        currentLang: () => i18next.language,
      };
    });
  </script>

  <script is:inline>
    // Menu functionality
    document.addEventListener("DOMContentLoaded", () => {
      const menuToggle = document.getElementById("menu-toggle");
      const mobileMenu = document.getElementById("mobile-menu");
      const closeMenu = document.getElementById("close-menu");

      if (!menuToggle || !mobileMenu || !closeMenu) return;

      if (typeof gsap === "undefined") {
        console.error("GSAP no est√° disponible");
        return;
      }

      menuToggle.addEventListener("click", () => {
        mobileMenu.classList.remove("hidden");
        mobileMenu.classList.add("flex");

        gsap.to(mobileMenu, {
          x: "-100%",
          duration: 0.5,
          ease: "power2.out",
        });
      });

      closeMenu.addEventListener("click", () => {
        gsap.to(mobileMenu, {
          x: "100%",
          duration: 0.5,
          ease: "power2.in",
          onComplete: () => {
            mobileMenu.classList.add("hidden");
            mobileMenu.classList.remove("flex");
          },
        });
      });
    });
  </script>

  <script is:inline>
    // Animations and header functionality
    document.addEventListener("DOMContentLoaded", () => {
      const nav = document.getElementById("desktop-nav");
      const navLinks = document.querySelectorAll(".nav-link");
      const header = document.querySelector("header");

      if (typeof gsap === "undefined") {
        console.error("GSAP no est√° disponible para animaciones");
        return;
      }

      // Crear underline para animaciones
      if (nav && navLinks.length > 0) {
        const underline = document.createElement("div");
        underline.classList.add("underline-effect");
        nav.appendChild(underline);

        nav.style.position = "relative";

        gsap.set(underline, { width: "0px", opacity: 0, scaleX: 0.5 });

        navLinks.forEach((link) => {
          link.addEventListener("mouseenter", (event) => {
            const linkRect = link.getBoundingClientRect();
            const navRect = nav.getBoundingClientRect();

            gsap.to(underline, {
              width: linkRect.width + "px",
              height: "3px",
              left: linkRect.left - navRect.left + "px",
              top: linkRect.bottom - navRect.top - 2 + "px",
              opacity: 1,
              background:
                "linear-gradient(90deg, rgb(0, 81, 107), rgb(255, 255, 255), rgb(0, 81, 107))",
              boxShadow: "0 0 10px rgb(15, 94, 173)",
              scaleX: 1.3,
              duration: 0.3,
              ease: "power3.out",
            });
          });

          link.addEventListener("mouseleave", () => {
            gsap.to(underline, {
              width: "0px",
              opacity: 0,
              scaleX: 0.5,
              duration: 0.3,
              ease: "power3.in",
            });
          });
        });
      }

      // Actualizar --anchor-offset seg√∫n la altura del header
      function setAnchorOffset() {
        const h = header ? header.getBoundingClientRect().height : 80;
        const extra = 0;
        document.documentElement.style.setProperty(
          "--anchor-offset",
          `${h + extra}px`
        );
      }

      setAnchorOffset();
      window.addEventListener("resize", setAnchorOffset);

      if (header && "ResizeObserver" in window) {
        const ro = new ResizeObserver(() => setAnchorOffset());
        ro.observe(header);
      }
    });
  </script>

  <script is:inline>
    // Typed.js initialization
    (function () {
      let typedInstance = null;
      let retryCount = 0;
      const maxRetries = 10;

      function initTyped() {
        console.log(
          "üöÄ Intentando inicializar Typed.js... (intento " +
            (retryCount + 1) +
            ")"
        );
        console.log("Typed disponible?", typeof Typed);

        const typedElement = document.getElementById("typed-text");

        if (!typedElement) {
          console.error("‚ùå Elemento #typed-text no encontrado");
          return;
        }

        console.log("‚úÖ Elemento encontrado:", typedElement);

        if (typeof Typed === "undefined") {
          retryCount++;
          if (retryCount < maxRetries) {
            console.warn(
              "‚è≥ Typed.js no est√° cargado. Reintentando en 300ms... (intento " +
                retryCount +
                "/" +
                maxRetries +
                ")"
            );
            setTimeout(initTyped, 300);
          } else {
            console.error(
              "‚ùå Typed.js no se pudo cargar despu√©s de " +
                maxRetries +
                " intentos"
            );
          }
          return;
        }

        console.log("‚úÖ Typed.js est√° disponible!");
        retryCount = 0; // Reset counter

        // Destruir instancia anterior si existe
        if (typedInstance) {
          typedInstance.destroy();
          console.log("üóëÔ∏è Instancia anterior destruida");
        }

        // Limpiar cualquier contenido previo
        typedElement.textContent = "";

        // Obtener las strings traducidas
        const currentLang = localStorage.getItem("lang") || "es";
        let strings = [
          "Desarrollador Full Stack",
          "Ingeniero de Software",
          "Desarrollador Web",
          "Arquitecto de Soluciones",
        ];

        if (currentLang === "en") {
          strings = [
            "Full Stack Developer",
            "Software Engineer",
            "Web Developer",
            "Solutions Architect",
          ];
        }

        console.log("üìù Strings a usar:", strings);
        console.log("üåê Idioma actual:", currentLang);

        // Inicializar Typed.js
        try {
          typedInstance = new Typed("#typed-text", {
            strings: strings,
            typeSpeed: 50,
            backSpeed: 30,
            backDelay: 2000,
            loop: true,
            showCursor: true,
            cursorChar: "|",
          });

          console.log("‚úÖ Typed.js inicializado correctamente!", typedInstance);
        } catch (error) {
          console.error("‚ùå Error al inicializar Typed.js:", error);
        }
      }

      // Funci√≥n para reiniciar con cambio de idioma
      window.restartTyped = function () {
        console.log("üîÑ Reiniciando Typed.js...");
        if (typedInstance) {
          typedInstance.destroy();
          typedInstance = null;
        }
        setTimeout(initTyped, 100);
      };

      // Inicializar cuando el DOM est√© listo
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", function () {
          console.log("üìÑ DOM cargado");
          setTimeout(initTyped, 1500);
        });
      } else {
        console.log("üìÑ DOM ya estaba cargado");
        setTimeout(initTyped, 1500);
      }

      // Reinicializar cuando cambie el idioma
      window.addEventListener("languageChanged", function () {
        console.log("üîÑ Evento languageChanged recibido");
        window.restartTyped();
      });
    })();
  </script>
</html>
